import{s as i}from"./supabaseClient-8CxNeXQr.js";import{i as mt}from"./roles-Dahpx40n.js";document.addEventListener("DOMContentLoaded",async()=>{var tt;const U=document.getElementById("logoutBtn"),q=document.getElementById("createCategoryBtn"),F=document.getElementById("addPromptBtn"),et=document.getElementById("nav-dashboard"),rt=document.getElementById("nav-admin"),nt=document.getElementById("nav-login"),at=document.getElementById("nav-register"),ot=document.getElementById("nav-logout"),lt=document.getElementById("nav-user-email"),D=document.getElementById("nav-divider"),B=document.getElementById("categoriesLoading"),h=document.getElementById("categoriesList"),v=document.getElementById("categoriesEmpty"),x=document.getElementById("promptsLoading"),E=document.getElementById("promptsContainer"),b=document.getElementById("promptsEmpty"),S=document.getElementById("stat-my-prompts"),H=document.getElementById("stat-my-categories"),R=document.getElementById("stat-my-recent"),{data:{session:w},error:st}=await i.auth.getSession(),P=!st&&!!w,I=((tt=w==null?void 0:w.user)==null?void 0:tt.id)||null;if(!P||!I){window.location.href="../login/login.html";return}const N=document.getElementById("user-email");if(P&&N){const{data:{user:e},error:t}=await i.auth.getUser();!t&&(e!=null&&e.email)&&(N.textContent=e.email)}et.style.display="block",rt.style.display=await mt(I)?"block":"none",nt.style.display="none",at.style.display="none",ot.style.display="block",lt.style.display="block",D&&D.style.setProperty("display","flex","important"),U&&U.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await i.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});let g=null;async function O(){try{B.style.display="block",h.style.display="none",v.style.display="none";let e=i.from("categories").select("*").order("created_at",{ascending:!1});e=e.eq("user_id",I);const{data:t,error:c}=await e;if(c)throw c;if(H.textContent=(t==null?void 0:t.length)??0,B.style.display="none",t.length===0)v.style.display="block";else{h.style.display="block",h.innerHTML="";const n=document.createElement("li");n.className="nav-item mb-1",n.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${g===null?"active-category":""}" href="#" data-id="">
            üìÅ All Categories
          </a>
        `,h.appendChild(n),t.forEach(a=>{const d=document.createElement("li");d.className="nav-item mb-1",d.innerHTML=`
            <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${g===a.id?"active-category":""}" href="#" data-id="${a.id}">
              üìÅ ${a.name}
            </a>
          `,h.appendChild(d)}),document.querySelectorAll(".category-link").forEach(a=>{a.addEventListener("click",d=>{d.preventDefault(),document.querySelectorAll(".category-link").forEach(p=>p.classList.remove("active-category")),d.currentTarget.classList.add("active-category");const o=d.currentTarget.getAttribute("data-id");g=o||null,f()})})}}catch(e){console.error("Error fetching categories:",e.message),H.textContent="0",B.style.display="none",v.style.display="block",v.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function f(){try{x.style.display="block",E.style.display="none",b.style.display="none";let e=i.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});e=e.eq("user_id",I),g&&(e=e.eq("category_id",g));const{data:t,error:c}=await e;if(c)throw c;const n=(t==null?void 0:t.length)??0,a=new Date;a.setDate(a.getDate()-7);const d=(t||[]).filter(o=>o.created_at?new Date(o.created_at)>=a:!1).length;if(S.textContent=n,R.textContent=d,x.style.display="none",t.length===0)b.style.display="block";else{E.style.display="flex",E.innerHTML="";const o=[];t.forEach(r=>{r.file_url&&r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&o.push(r.file_url)});let p={};if(o.length>0){const{data:r,error:u}=await i.storage.from("prompt-attachments").createSignedUrls(o,3600);!u&&r&&r.forEach(s=>{s.error||(p[s.path]=s.signedUrl)})}t.forEach(r=>{var y;const u=((y=r.categories)==null?void 0:y.name)||"Uncategorized",s=document.createElement("div");s.className="col";let l="",m="";r.file_url&&(r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&p[r.file_url]?m+=`<img src="${p[r.file_url]}" class="card-img-top mb-2" alt="Attachment Preview" style="max-height: 150px; object-fit: cover;">`:l+=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${r.file_url}">üìé View Attachment</button>`),s.innerHTML=`
            <div class="card h-100 shadow-sm">
              ${m?`<div class="p-2 d-flex flex-wrap gap-2">${m}</div>`:""}
              <div class="card-body">
                <h5 class="card-title">${r.title}</h5>
                <h6 class="card-subtitle mb-2 text-muted">üìÅ ${u}</h6>
                <p class="card-text text-truncate">${r.prompt_text}</p>
                <div class="d-flex flex-wrap">
                  ${l}
                </div>
              </div>
              <div class="card-footer bg-transparent border-top-0 d-flex flex-wrap gap-2 justify-content-start">
                <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${r.id}">View Details</button>
                <button class="btn btn-sm btn-outline-secondary edit-prompt-btn" data-id="${r.id}">Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-prompt-btn" data-id="${r.id}">Delete</button>
              </div>
            </div>
          `,E.appendChild(s)}),document.querySelectorAll(".view-attachment-btn").forEach(r=>{r.addEventListener("click",async u=>{const s=u.currentTarget.getAttribute("data-url"),{data:l,error:m}=await i.storage.from("prompt-attachments").createSignedUrl(s,3600);l?window.open(l.signedUrl,"_blank"):(console.error("Error getting signed URL:",m),alert("Failed to load attachment."))})}),document.querySelectorAll(".view-prompt-btn").forEach(r=>{r.addEventListener("click",u=>{const s=u.currentTarget.getAttribute("data-id"),l=t.find(m=>m.id===s);l&&Z(l)})}),document.querySelectorAll(".edit-prompt-btn").forEach(r=>{r.addEventListener("click",u=>{const s=u.currentTarget.getAttribute("data-id"),l=t.find(m=>m.id===s);l&&Z(l)})}),document.querySelectorAll(".delete-prompt-btn").forEach(r=>{r.addEventListener("click",async u=>{if(confirm("Are you sure you want to delete this prompt?")){const s=u.currentTarget.getAttribute("data-id");try{const l=t.find(y=>y.id===s);l&&l.file_url&&await i.storage.from("prompt-attachments").remove([l.file_url]);const{error:m}=await i.from("prompts").delete().eq("id",s);if(m)throw m;f()}catch(l){console.error("Error deleting prompt:",l.message),alert("Failed to delete prompt.")}}})})}}catch(e){console.error("Error fetching prompts:",e.message),S.textContent="0",R.textContent="0",x.style.display="none",b.style.display="block",b.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}O(),f();const j=new window.bootstrap.Modal(document.getElementById("createCategoryModal")),it=document.getElementById("saveCategoryBtn"),V=document.getElementById("categoryName");q&&q.addEventListener("click",()=>{V.value="",j.show()}),it.addEventListener("click",async()=>{const e=V.value.trim();if(!e){alert("Please enter a category name.");return}try{const{data:{user:t},error:c}=await i.auth.getUser();if(c||!t)throw new Error("User not authenticated");const{error:n}=await i.from("categories").insert([{name:e,user_id:t.id}]);if(n)throw n;j.hide(),O()}catch(t){console.error("Error creating category:",t.message),alert("Failed to create category: "+t.message)}});const z=new window.bootstrap.Modal(document.getElementById("addPromptModal")),ct=document.getElementById("savePromptBtn"),Q=document.getElementById("promptTitle"),G=document.getElementById("promptText"),J=document.getElementById("promptResult"),K=document.getElementById("promptFile");F&&F.addEventListener("click",()=>{if(!g){alert("Please select a category first to add a prompt.");return}Q.value="",G.value="",J.value="",K.value="",z.show()}),ct.addEventListener("click",async()=>{const e=Q.value.trim(),t=G.value.trim(),c=J.value.trim(),n=K.files;if(!e||!t){alert("Please fill in the required fields (Title and Prompt Text).");return}try{const{data:{user:a},error:d}=await i.auth.getUser();if(d||!a)throw new Error("User not authenticated");let o=null;if(n&&n.length>0){const r=n[0],u=r.name.split(".").pop(),s=`${Math.random().toString(36).substring(2,15)}.${u}`,l=`${a.id}/${s}`,{error:m}=await i.storage.from("prompt-attachments").upload(l,r);if(m)throw m;o=l}const{error:p}=await i.from("prompts").insert([{title:e,prompt_text:t,result_text:c,category_id:g,user_id:a.id,file_url:o}]);if(p)throw p;z.hide(),f(),alert("Prompt saved successfully!")}catch(a){console.error("Error creating prompt:",a.message),alert("Failed to create prompt: "+a.message)}});const W=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),X=document.getElementById("updatePromptBtn"),Y=document.getElementById("editPromptId"),L=document.getElementById("editPromptOldFileUrl"),_=document.getElementById("editPromptTitle"),k=document.getElementById("editPromptText"),A=document.getElementById("editPromptResult"),T=document.getElementById("editPromptFile"),$=document.getElementById("currentAttachmentContainer"),C=document.getElementById("currentAttachmentsList");async function Z(e){const t=!P;Y.value=e.id,L.value=e.file_url||"",_.value=e.title,k.value=e.prompt_text,A.value=e.result_text||"",T.value="",_.readOnly=t,k.readOnly=t,A.readOnly=t,T.disabled=t,X.style.display=t?"none":"inline-block",C.innerHTML="";let c=!1;if(e.file_url){c=!0;const{data:n,error:a}=await i.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600),d=n?n.signedUrl:"#",o=document.createElement("li");o.className="mb-2 d-flex align-items-center",o.innerHTML=`
        <a href="${d}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>
        ${t?"":`<button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn" data-id="${e.id}" data-url="${e.file_url}">Remove</button>`}
      `,C.appendChild(o)}c?($.style.display="block",t||document.querySelectorAll(".remove-attachment-btn").forEach(n=>{n.addEventListener("click",dt)})):$.style.display="none",W.show()}async function dt(e){if(confirm("Are you sure you want to remove this attachment?")){const t=e.currentTarget.getAttribute("data-id"),c=e.currentTarget.getAttribute("data-url");try{const{error:n}=await i.storage.from("prompt-attachments").remove([c]);if(n)throw n;const{error:a}=await i.from("prompts").update({file_url:null}).eq("id",t);if(a)throw a;e.currentTarget.closest("li").remove(),C.children.length===0&&($.style.display="none"),L.value="",alert("Attachment removed successfully!"),f()}catch(n){console.error("Error removing attachment:",n.message),alert("Failed to remove attachment: "+n.message)}}}X.addEventListener("click",async()=>{const e=Y.value,t=L.value,c=_.value.trim(),n=k.value.trim(),a=A.value.trim(),d=T.files;if(!c||!n){alert("Please fill in the required fields (Title and Prompt Text).");return}try{const{data:{user:o},error:p}=await i.auth.getUser();if(p||!o)throw new Error("User not authenticated");let r={title:c,prompt_text:n,result_text:a};if(d&&d.length>0){const s=d[0],l=s.name.split(".").pop(),m=`${Math.random().toString(36).substring(2,15)}.${l}`,y=`${o.id}/${m}`,{error:M}=await i.storage.from("prompt-attachments").upload(y,s);if(M)throw M;t&&await i.storage.from("prompt-attachments").remove([t]),r.file_url=y}const{error:u}=await i.from("prompts").update(r).eq("id",e);if(u)throw u;W.hide(),f(),alert("Prompt updated successfully!")}catch(o){console.error("Error updating prompt:",o.message),alert("Failed to update prompt: "+o.message)}})});
