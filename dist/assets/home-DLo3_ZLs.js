import{s as d}from"./supabaseClient-8CxNeXQr.js";import{i as te}from"./roles-CRsL3K8t.js";document.addEventListener("DOMContentLoaded",async()=>{var q,R;const b=document.getElementById("main-navbar"),L=document.getElementById("logout-btn"),A=document.getElementById("nav-home"),B=document.getElementById("nav-dashboard"),P=document.getElementById("nav-admin"),$=document.getElementById("nav-login"),T=document.getElementById("nav-register"),M=document.getElementById("nav-logout"),C=document.getElementById("nav-user-email"),v=document.getElementById("nav-divider"),z=document.getElementById("user-email-display"),U=document.getElementById("categoriesLoading"),h=document.getElementById("categoriesList"),E=document.getElementById("categoriesEmpty"),k=document.getElementById("promptsLoading"),w=document.getElementById("promptsContainer"),_=document.getElementById("promptsEmpty"),{data:{session:m},error:Q}=await d.auth.getSession(),W=!Q&&!!m,G=((q=m==null?void 0:m.user)==null?void 0:q.id)||null,J=((R=m==null?void 0:m.user)==null?void 0:R.email)||null;if(W){const e=await te(G);A.style.display="block",B.style.display="block",P.style.display=e?"block":"none",$.style.display="none",T.style.display="none",M.style.display="block",C.style.display="block",z.textContent=J,v&&v.style.setProperty("display","flex","important"),b&&b.classList.remove("navbar-guest-mode")}else A.style.display="none",B.style.display="none",P.style.display="none",$.style.display="block",T.style.display="block",M.style.display="none",C.style.display="none",v&&v.style.setProperty("display","none","important"),b&&b.classList.add("navbar-guest-mode");L&&L.addEventListener("click",async e=>{e.preventDefault();const{error:r}=await d.auth.signOut();r?(console.error("Error logging out:",r.message),alert("Failed to log out.")):window.location.reload()});let x=null;function g(e){return/^https?:\/\//i.test(e||"")}function K(e){if(!e)return"";if(g(e))try{return new URL(e).pathname||""}catch{return e.split("?")[0]}return e.split("?")[0]}function I(e){return/\.(jpeg|jpg|gif|png|webp)$/i.test(K(e))}function X(e,r){if(e){const l=e.indexOf("@");return l>0?e.slice(0,l):e}return r?`User ${r.slice(0,8)}`:"Unknown author"}async function Y(){try{U.style.display="block",h.style.display="none",E.style.display="none";const{data:e,error:r}=await d.from("categories").select("*").order("created_at",{ascending:!1});if(r)throw r;if(U.style.display="none",!e||e.length===0){E.style.display="block";return}h.style.display="block",h.innerHTML="";const l=document.createElement("li");l.className="nav-item mb-1",l.innerHTML=`
        <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${x===null?"active-category":""}" href="#" data-id="">
          üìÅ All Categories
        </a>
      `,h.appendChild(l),e.forEach(s=>{const i=document.createElement("li");i.className="nav-item mb-1",i.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${x===s.id?"active-category":""}" href="#" data-id="${s.id}">
            üìÅ ${s.name}
          </a>
        `,h.appendChild(i)}),document.querySelectorAll(".category-link").forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),document.querySelectorAll(".category-link").forEach(p=>p.classList.remove("active-category")),i.currentTarget.classList.add("active-category");const y=i.currentTarget.getAttribute("data-id");x=y||null,H()})})}catch(e){console.error("Error fetching categories:",e.message),U.style.display="none",E.style.display="block",E.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function H(){try{k.style.display="block",w.style.display="none",_.style.display="none";const{data:e,error:r}=await d.rpc("get_public_prompts_with_authors",{p_category_id:x});if(r)throw r;if(k.style.display="none",!e||e.length===0){_.style.display="block";return}w.style.display="flex",w.innerHTML="";const l=[],s=[],i={};e.forEach(t=>{t.file_url&&(g(t.file_url)?i[t.file_url]=t.file_url:(s.push(t.file_url),I(t.file_url)&&l.push(t.file_url)),g(t.file_url)&&I(t.file_url)&&l.push(t.file_url))});const y={},p={};if(s.length>0){const t=[...new Set(s)],{data:a,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&a&&a.forEach(n=>{!n.error&&n.path&&n.signedUrl&&(p[n.path]=n.signedUrl)}),t.forEach(n=>{if(!p[n]){const{data:c}=d.storage.from("prompt-attachments").getPublicUrl(n);c!=null&&c.publicUrl&&(p[n]=c.publicUrl)}})}if(Object.entries(i).forEach(([t,a])=>{p[t]=a}),l.length>0){const t=l.filter(a=>!g(a));if(t.length>0){const{data:a,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&a&&a.forEach(n=>{n.error||(y[n.path]=n.signedUrl)})}l.filter(a=>g(a)).forEach(a=>{y[a]=a})}e.forEach(t=>{const a=t.category_name||"Uncategorized",o=X(t.author_email,t.user_id),n=document.createElement("div");n.className="col";let c="",f="";if(t.file_url){const u=p[t.file_url]||"",V=I(t.file_url);V&&y[t.file_url]?f=`<img src="${y[t.file_url]}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`:V&&u&&(f=`<img src="${u}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`),c=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}" data-resolved-url="${u}">üìé View Attachment</button>`}n.innerHTML=`
          <div class="card h-100 shadow-sm">
            ${f?`<div class="p-2 d-flex flex-wrap gap-2">${f}</div>`:""}
            <div class="card-body">
              <h5 class="card-title">${t.title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">üìÅ ${a}</h6>
              <p class="card-text text-muted small mb-2">By: ${o}</p>
              <p class="card-text text-truncate">${t.prompt_text}</p>
              <div class="d-flex flex-wrap">${c}</div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-start flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${t.id}">View Details</button>
            </div>
          </div>
        `,w.appendChild(n)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async a=>{const o=a.currentTarget.getAttribute("data-url"),n=a.currentTarget.getAttribute("data-resolved-url");if(n){window.open(n,"_blank");return}if(g(o)){window.open(o,"_blank");return}const{data:c,error:f}=await d.storage.from("prompt-attachments").createSignedUrl(o,3600);if(c)window.open(c.signedUrl,"_blank");else{const{data:u}=d.storage.from("prompt-attachments").getPublicUrl(o);u!=null&&u.publicUrl?window.open(u.publicUrl,"_blank"):(console.error("Error getting signed URL:",f),alert("Failed to load attachment."))}})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",a=>{const o=a.currentTarget.getAttribute("data-id"),n=e.find(c=>c.id===o);n&&ee(n)})})}catch(e){console.error("Error fetching prompts:",e.message),k.style.display="none",_.style.display="block",_.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}const Z=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),S=document.getElementById("editPromptTitle"),F=document.getElementById("editPromptText"),O=document.getElementById("editPromptResult"),N=document.getElementById("editPromptFile"),j=document.getElementById("currentAttachmentContainer"),D=document.getElementById("currentAttachmentsList");async function ee(e){if(S.value=e.title,F.value=e.prompt_text,O.value=e.result_text||"",N.value="",S.readOnly=!0,F.readOnly=!0,O.readOnly=!0,N.disabled=!0,D.innerHTML="",e.file_url){let r=e.file_url;if(!g(e.file_url)){const{data:s}=await d.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600);if(s!=null&&s.signedUrl)r=s.signedUrl;else{const{data:i}=d.storage.from("prompt-attachments").getPublicUrl(e.file_url);r=(i==null?void 0:i.publicUrl)||"#"}}const l=document.createElement("li");l.className="mb-2 d-flex align-items-center",l.innerHTML=`<a href="${r}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>`,D.appendChild(l),j.style.display="block"}else j.style.display="none";Z.show()}Y(),H()});
