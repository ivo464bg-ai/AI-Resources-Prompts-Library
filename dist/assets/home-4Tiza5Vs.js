import{s as d}from"./supabaseClient-8CxNeXQr.js";import{i as re}from"./roles-Dahpx40n.js";document.addEventListener("DOMContentLoaded",async()=>{var Q,W;const $=document.getElementById("logout-btn"),M=document.getElementById("nav-dashboard"),T=document.getElementById("nav-admin"),C=document.getElementById("nav-login"),H=document.getElementById("nav-register"),S=document.getElementById("nav-logout"),F=document.getElementById("nav-user-email"),v=document.getElementById("nav-divider"),J=document.getElementById("user-email-display"),k=document.getElementById("categoriesLoading"),p=document.getElementById("categoriesList"),E=document.getElementById("categoriesEmpty"),L=document.getElementById("promptsLoading"),w=document.getElementById("promptsContainer"),_=document.getElementById("promptsEmpty"),{data:{session:u},error:K}=await d.auth.getSession(),X=!K&&!!u,A=((Q=u==null?void 0:u.user)==null?void 0:Q.id)||null,I=((W=u==null?void 0:u.user)==null?void 0:W.email)||null;if(X){const e=await re(A);M.style.display="block",T.style.display=e?"block":"none",C.style.display="none",H.style.display="none",S.style.display="block",F.style.display="block",J.textContent=I,v&&v.style.setProperty("display","flex","important")}else M.style.display="none",T.style.display="none",C.style.display="block",H.style.display="block",S.style.display="none",F.style.display="none",v&&v.style.setProperty("display","none","important");$&&$.addEventListener("click",async e=>{e.preventDefault();const{error:n}=await d.auth.signOut();n?(console.error("Error logging out:",n.message),alert("Failed to log out.")):window.location.reload()});let h=null;const q=new Map;function m(e){return/^https?:\/\//i.test(e||"")}function Y(e){if(!e)return"";if(m(e))try{return new URL(e).pathname||""}catch{return e.split("?")[0]}return e.split("?")[0]}function B(e){return/\.(jpeg|jpg|gif|png|webp)$/i.test(Y(e))}function Z(e){const n=q.get(e);return n||(A&&e===A&&I?I:e?`User ${e.slice(0,8)}`:"Unknown author")}async function ee(e){if(e.length)try{const{data:n,error:i}=await d.from("profiles").select("id, username").in("id",e);if(i||!n)return;n.forEach(r=>{r!=null&&r.id&&(r!=null&&r.username)&&q.set(r.id,r.username)})}catch(n){console.error("Unable to load author usernames:",n.message)}}async function te(){try{k.style.display="block",p.style.display="none",E.style.display="none";const{data:e,error:n}=await d.from("categories").select("*").order("created_at",{ascending:!1});if(n)throw n;if(k.style.display="none",!e||e.length===0){E.style.display="block";return}p.style.display="block",p.innerHTML="";const i=document.createElement("li");i.className="nav-item mb-1",i.innerHTML=`
        <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${h===null?"active-category":""}" href="#" data-id="">
          üìÅ All Categories
        </a>
      `,p.appendChild(i),e.forEach(r=>{const s=document.createElement("li");s.className="nav-item mb-1",s.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${h===r.id?"active-category":""}" href="#" data-id="${r.id}">
            üìÅ ${r.name}
          </a>
        `,p.appendChild(s)}),document.querySelectorAll(".category-link").forEach(r=>{r.addEventListener("click",s=>{s.preventDefault(),document.querySelectorAll(".category-link").forEach(x=>x.classList.remove("active-category")),s.currentTarget.classList.add("active-category");const y=s.currentTarget.getAttribute("data-id");h=y||null,O()})})}catch(e){console.error("Error fetching categories:",e.message),k.style.display="none",E.style.display="block",E.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function O(){try{L.style.display="block",w.style.display="none",_.style.display="none";let e=d.from("prompts").select("id, title, prompt_text, result_text, file_url, user_id, created_at, category_id, categories(name)").order("created_at",{ascending:!1});h&&(e=e.eq("category_id",h));const{data:n,error:i}=await e;if(i)throw i;if(L.style.display="none",!n||n.length===0){_.style.display="block";return}const r=[...new Set(n.map(t=>t.user_id).filter(Boolean))];await ee(r),w.style.display="flex",w.innerHTML="";const s=[],y=[],x={};n.forEach(t=>{t.file_url&&(m(t.file_url)?x[t.file_url]=t.file_url:(y.push(t.file_url),B(t.file_url)&&s.push(t.file_url)),m(t.file_url)&&B(t.file_url)&&s.push(t.file_url))});const U={},b={};if(y.length>0){const t=[...new Set(y)],{data:l,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&l&&l.forEach(a=>{!a.error&&a.path&&a.signedUrl&&(b[a.path]=a.signedUrl)}),t.forEach(a=>{if(!b[a]){const{data:c}=d.storage.from("prompt-attachments").getPublicUrl(a);c!=null&&c.publicUrl&&(b[a]=c.publicUrl)}})}if(Object.entries(x).forEach(([t,l])=>{b[t]=l}),s.length>0){const t=s.filter(l=>!m(l));if(t.length>0){const{data:l,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&l&&l.forEach(a=>{a.error||(U[a.path]=a.signedUrl)})}s.filter(l=>m(l)).forEach(l=>{U[l]=l})}n.forEach(t=>{var g;const l=((g=t.categories)==null?void 0:g.name)||"Uncategorized",o=Z(t.user_id),a=document.createElement("div");a.className="col";let c="",f="";if(t.file_url){const P=b[t.file_url]||"",G=B(t.file_url);G&&U[t.file_url]?f=`<img src="${U[t.file_url]}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`:G&&P&&(f=`<img src="${P}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`),c=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}" data-resolved-url="${P}">üìé View Attachment</button>`}a.innerHTML=`
          <div class="card h-100 shadow-sm">
            ${f?`<div class="p-2 d-flex flex-wrap gap-2">${f}</div>`:""}
            <div class="card-body">
              <h5 class="card-title">${t.title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">üìÅ ${l}</h6>
              <p class="card-text text-muted small mb-2">By: ${o}</p>
              <p class="card-text text-truncate">${t.prompt_text}</p>
              <div class="d-flex flex-wrap">${c}</div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-start flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${t.id}">View Details</button>
            </div>
          </div>
        `,w.appendChild(a)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async l=>{const o=l.currentTarget.getAttribute("data-url"),a=l.currentTarget.getAttribute("data-resolved-url");if(a){window.open(a,"_blank");return}if(m(o)){window.open(o,"_blank");return}const{data:c,error:f}=await d.storage.from("prompt-attachments").createSignedUrl(o,3600);if(c)window.open(c.signedUrl,"_blank");else{const{data:g}=d.storage.from("prompt-attachments").getPublicUrl(o);g!=null&&g.publicUrl?window.open(g.publicUrl,"_blank"):(console.error("Error getting signed URL:",f),alert("Failed to load attachment."))}})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",l=>{const o=l.currentTarget.getAttribute("data-id"),a=n.find(c=>c.id===o);a&&ae(a)})})}catch(e){console.error("Error fetching prompts:",e.message),L.style.display="none",_.style.display="block",_.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}const ne=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),j=document.getElementById("editPromptTitle"),D=document.getElementById("editPromptText"),N=document.getElementById("editPromptResult"),R=document.getElementById("editPromptFile"),V=document.getElementById("currentAttachmentContainer"),z=document.getElementById("currentAttachmentsList");async function ae(e){if(j.value=e.title,D.value=e.prompt_text,N.value=e.result_text||"",R.value="",j.readOnly=!0,D.readOnly=!0,N.readOnly=!0,R.disabled=!0,z.innerHTML="",e.file_url){let n=e.file_url;if(!m(e.file_url)){const{data:r}=await d.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600);if(r!=null&&r.signedUrl)n=r.signedUrl;else{const{data:s}=d.storage.from("prompt-attachments").getPublicUrl(e.file_url);n=(s==null?void 0:s.publicUrl)||"#"}}const i=document.createElement("li");i.className="mb-2 d-flex align-items-center",i.innerHTML=`<a href="${n}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>`,z.appendChild(i),V.style.display="block"}else V.style.display="none";ne.show()}te(),O()});
