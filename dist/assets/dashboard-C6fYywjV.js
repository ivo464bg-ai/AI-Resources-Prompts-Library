import{s as i}from"./supabaseClient-8CxNeXQr.js";/* empty css               */import{i as ft}from"./roles-BbqFL7ZG.js";document.addEventListener("DOMContentLoaded",async()=>{var at;const z=document.getElementById("main-navbar"),Q=document.getElementById("logoutBtn"),G=document.getElementById("createCategoryBtn"),J=document.getElementById("addPromptBtn"),ot=document.getElementById("nav-home"),lt=document.getElementById("nav-categories"),st=document.getElementById("nav-explore"),it=document.getElementById("nav-dashboard"),ct=document.getElementById("nav-admin"),dt=document.getElementById("nav-login"),mt=document.getElementById("nav-register"),ut=document.getElementById("nav-logout"),pt=document.getElementById("nav-user-email"),K=document.getElementById("nav-divider"),N=document.getElementById("categoriesLoading"),h=document.getElementById("categoriesList"),B=document.getElementById("categoriesEmpty"),R=document.getElementById("promptsLoading"),x=document.getElementById("promptsContainer"),P=document.getElementById("promptsEmpty"),W=document.getElementById("stat-my-prompts"),X=document.getElementById("stat-my-categories"),Y=document.getElementById("stat-my-recent");function O(e){var c;const t=document.getElementById(e);return!t||!((c=window.bootstrap)!=null&&c.Modal)?null:new window.bootstrap.Modal(t)}const{data:{session:k},error:gt}=await i.auth.getSession(),j=!gt&&!!k,L=((at=k==null?void 0:k.user)==null?void 0:at.id)||null;if(!j||!L){window.location.href="../login/login.html";return}const Z=document.getElementById("user-email");if(j&&Z){const{data:{user:e},error:t}=await i.auth.getUser();!t&&(e!=null&&e.email)&&(Z.textContent=e.email)}it.style.display="block",ot.style.display="block",lt.style.display="block",st.style.display="block",ct.style.display=await ft(L)?"block":"none",dt.style.display="none",mt.style.display="none",ut.style.display="block",pt.style.display="block",K&&K.style.setProperty("display","flex","important"),z&&z.classList.remove("navbar-guest-mode"),Q&&Q.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await i.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});let g=null;async function tt(){try{N.style.display="block",h.style.display="none",B.style.display="none";let e=i.from("categories").select("*").order("created_at",{ascending:!1});e=e.eq("user_id",L);const{data:t,error:c}=await e;if(c)throw c;if(X.textContent=(t==null?void 0:t.length)??0,N.style.display="none",t.length===0)B.style.display="block";else{h.style.display="block",h.innerHTML="";const n=document.createElement("li");n.className="nav-item mb-1",n.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${g===null?"active-category":""}" href="#" data-id="">
            üìÅ All Categories
          </a>
        `,h.appendChild(n),t.forEach(a=>{const d=document.createElement("li");d.className="nav-item mb-1",d.innerHTML=`
            <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${g===a.id?"active-category":""}" href="#" data-id="${a.id}">
              üìÅ ${a.name}
            </a>
          `,h.appendChild(d)}),document.querySelectorAll(".category-link").forEach(a=>{a.addEventListener("click",d=>{d.preventDefault(),document.querySelectorAll(".category-link").forEach(p=>p.classList.remove("active-category")),d.currentTarget.classList.add("active-category");const o=d.currentTarget.getAttribute("data-id");g=o||null,f()})})}}catch(e){console.error("Error fetching categories:",e.message),X.textContent="0",N.style.display="none",B.style.display="block",B.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function f(){try{R.style.display="block",x.style.display="none",P.style.display="none";let e=i.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});e=e.eq("user_id",L),g&&(e=e.eq("category_id",g));const{data:t,error:c}=await e;if(c)throw c;const n=(t==null?void 0:t.length)??0,a=new Date;a.setDate(a.getDate()-7);const d=(t||[]).filter(o=>o.created_at?new Date(o.created_at)>=a:!1).length;if(W.textContent=n,Y.textContent=d,R.style.display="none",t.length===0)P.style.display="block";else{x.style.display="flex",x.innerHTML="";const o=[];t.forEach(r=>{r.file_url&&r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&o.push(r.file_url)});let p={};if(o.length>0){const{data:r,error:u}=await i.storage.from("prompt-attachments").createSignedUrls(o,3600);!u&&r&&r.forEach(s=>{s.error||(p[s.path]=s.signedUrl)})}t.forEach(r=>{var y;const u=((y=r.categories)==null?void 0:y.name)||"Uncategorized",s=document.createElement("div");s.className="col";let l="",m="";r.file_url&&(r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&p[r.file_url]?m+=`<img src="${p[r.file_url]}" class="card-img-top mb-2" alt="Attachment Preview" style="max-height: 150px; object-fit: cover;">`:l+=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${r.file_url}">üìé View Attachment</button>`),s.innerHTML=`
            <div class="card h-100 shadow-sm">
              ${m?`<div class="p-2 d-flex flex-wrap gap-2">${m}</div>`:""}
              <div class="card-body">
                <h5 class="card-title">${r.title}</h5>
                <h6 class="card-subtitle mb-2 text-muted">üìÅ ${u}</h6>
                <p class="card-text text-truncate">${r.prompt_text}</p>
                <div class="d-flex flex-wrap">
                  ${l}
                </div>
              </div>
              <div class="card-footer bg-transparent border-top-0 d-flex flex-wrap gap-2 justify-content-start">
                <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${r.id}">View Details</button>
                <button class="btn btn-sm btn-outline-secondary edit-prompt-btn" data-id="${r.id}">Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-prompt-btn" data-id="${r.id}">Delete</button>
              </div>
            </div>
          `,x.appendChild(s)}),document.querySelectorAll(".view-attachment-btn").forEach(r=>{r.addEventListener("click",async u=>{const s=u.currentTarget.getAttribute("data-url"),{data:l,error:m}=await i.storage.from("prompt-attachments").createSignedUrl(s,3600);l?window.open(l.signedUrl,"_blank"):(console.error("Error getting signed URL:",m),alert("Failed to load attachment."))})}),document.querySelectorAll(".view-prompt-btn").forEach(r=>{r.addEventListener("click",u=>{const s=u.currentTarget.getAttribute("data-id"),l=t.find(m=>m.id===s);l&&nt(l)})}),document.querySelectorAll(".edit-prompt-btn").forEach(r=>{r.addEventListener("click",u=>{const s=u.currentTarget.getAttribute("data-id"),l=t.find(m=>m.id===s);l&&nt(l)})}),document.querySelectorAll(".delete-prompt-btn").forEach(r=>{r.addEventListener("click",async u=>{if(confirm("Are you sure you want to delete this prompt?")){const s=u.currentTarget.getAttribute("data-id");try{const l=t.find(y=>y.id===s);l&&l.file_url&&await i.storage.from("prompt-attachments").remove([l.file_url]);const{error:m}=await i.from("prompts").delete().eq("id",s);if(m)throw m;f()}catch(l){console.error("Error deleting prompt:",l.message),alert("Failed to delete prompt.")}}})})}}catch(e){console.error("Error fetching prompts:",e.message),W.textContent="0",Y.textContent="0",R.style.display="none",P.style.display="block",P.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}tt(),f();const _=O("createCategoryModal"),et=document.getElementById("saveCategoryBtn"),A=document.getElementById("categoryName");G&&G.addEventListener("click",()=>{!_||!A||(A.value="",_.show())}),et&&et.addEventListener("click",async()=>{if(!A)return;const e=A.value.trim();if(!e){alert("Please enter a category name.");return}try{const{data:{user:t},error:c}=await i.auth.getUser();if(c||!t)throw new Error("User not authenticated");const{error:n}=await i.from("categories").insert([{name:e,user_id:t.id}]);if(n)throw n;_&&_.hide(),tt()}catch(t){console.error("Error creating category:",t.message),alert("Failed to create category: "+t.message)}});const T=O("addPromptModal"),rt=document.getElementById("savePromptBtn"),C=document.getElementById("promptTitle"),$=document.getElementById("promptText"),M=document.getElementById("promptResult"),U=document.getElementById("promptFile");J&&J.addEventListener("click",()=>{if(!(!T||!C||!$||!M||!U)){if(!g){alert("Please select a category first to add a prompt.");return}C.value="",$.value="",M.value="",U.value="",T.show()}}),rt&&rt.addEventListener("click",async()=>{if(!C||!$||!M||!U)return;const e=C.value.trim(),t=$.value.trim(),c=M.value.trim(),n=U.files;if(!e||!t){alert("Please fill in the required fields (Title and Prompt Text).");return}try{const{data:{user:a},error:d}=await i.auth.getUser();if(d||!a)throw new Error("User not authenticated");let o=null;if(n&&n.length>0){const r=n[0],u=r.name.split(".").pop(),s=`${Math.random().toString(36).substring(2,15)}.${u}`,l=`${a.id}/${s}`,{error:m}=await i.storage.from("prompt-attachments").upload(l,r);if(m)throw m;o=l}const{error:p}=await i.from("prompts").insert([{title:e,prompt_text:t,result_text:c,category_id:g,user_id:a.id,file_url:o}]);if(p)throw p;T&&T.hide(),f(),alert("Prompt saved successfully!")}catch(a){console.error("Error creating prompt:",a.message),alert("Failed to create prompt: "+a.message)}});const q=O("viewPromptModal"),F=document.getElementById("updatePromptBtn"),D=document.getElementById("editPromptId"),v=document.getElementById("editPromptOldFileUrl"),E=document.getElementById("editPromptTitle"),b=document.getElementById("editPromptText"),w=document.getElementById("editPromptResult"),I=document.getElementById("editPromptFile"),S=document.getElementById("currentAttachmentContainer"),H=document.getElementById("currentAttachmentsList");async function nt(e){if(!q||!D||!v||!E||!b||!w||!I||!F||!S||!H)return;const t=!j;D.value=e.id,v.value=e.file_url||"",E.value=e.title,b.value=e.prompt_text,w.value=e.result_text||"",I.value="",E.readOnly=t,b.readOnly=t,w.readOnly=t,I.disabled=t,F.style.display=t?"none":"inline-block",H.innerHTML="";let c=!1;if(e.file_url){c=!0;const{data:n,error:a}=await i.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600),d=n?n.signedUrl:"#",o=document.createElement("li");o.className="mb-2 d-flex align-items-center",o.innerHTML=`
        <a href="${d}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>
        ${t?"":`<button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn" data-id="${e.id}" data-url="${e.file_url}">Remove</button>`}
      `,H.appendChild(o)}c?(S.style.display="block",t||document.querySelectorAll(".remove-attachment-btn").forEach(n=>{n.addEventListener("click",yt)})):S.style.display="none",q.show()}async function yt(e){if(confirm("Are you sure you want to remove this attachment?")){const t=e.currentTarget.getAttribute("data-id"),c=e.currentTarget.getAttribute("data-url");try{const{error:n}=await i.storage.from("prompt-attachments").remove([c]);if(n)throw n;const{error:a}=await i.from("prompts").update({file_url:null}).eq("id",t);if(a)throw a;e.currentTarget.closest("li").remove(),H.children.length===0&&(S.style.display="none"),v.value="",alert("Attachment removed successfully!"),f()}catch(n){console.error("Error removing attachment:",n.message),alert("Failed to remove attachment: "+n.message)}}}F&&F.addEventListener("click",async()=>{if(!D||!v||!E||!b||!w||!I)return;const e=D.value,t=v.value,c=E.value.trim(),n=b.value.trim(),a=w.value.trim(),d=I.files;if(!c||!n){alert("Please fill in the required fields (Title and Prompt Text).");return}try{const{data:{user:o},error:p}=await i.auth.getUser();if(p||!o)throw new Error("User not authenticated");let r={title:c,prompt_text:n,result_text:a};if(d&&d.length>0){const s=d[0],l=s.name.split(".").pop(),m=`${Math.random().toString(36).substring(2,15)}.${l}`,y=`${o.id}/${m}`,{error:V}=await i.storage.from("prompt-attachments").upload(y,s);if(V)throw V;t&&await i.storage.from("prompt-attachments").remove([t]),r.file_url=y}const{error:u}=await i.from("prompts").update(r).eq("id",e);if(u)throw u;q&&q.hide(),f(),alert("Prompt updated successfully!")}catch(o){console.error("Error updating prompt:",o.message),alert("Failed to update prompt: "+o.message)}})});
