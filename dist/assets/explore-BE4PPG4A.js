import{s as m}from"./supabaseClient-5h-f_Tei.js";import{i as D}from"./auth-C10oIzEU.js";import"./roles-BcTnPyVM.js";document.addEventListener("DOMContentLoaded",async()=>{await D();const L=document.getElementById("categoriesLoading"),p=document.getElementById("categoriesList"),w=document.getElementById("categoriesEmpty"),v=document.getElementById("promptsLoading"),_=document.getElementById("promptsContainer"),h=document.getElementById("promptsEmpty"),M=document.getElementById("exploreTitle"),B=document.getElementById("clearFilterContainer"),x=(new URLSearchParams(window.location.search).get("category")||"").trim();function S(e){var a;const i=document.getElementById(e);return!i||!((a=window.bootstrap)!=null&&a.Modal)?null:new window.bootstrap.Modal(i)}let b=null,E=!1;function U(e){const i=(e||"").trim();M&&(M.textContent=i?`Explore: ${i}`:"Explore Prompts"),B&&(B.style.display=i?"block":"none")}function j(e){const i=(e||"").trim(),a=new URL(window.location.href);i?a.searchParams.set("category",i):a.searchParams.delete("category"),window.history.pushState({},"",`${a.pathname}${a.search}${a.hash}`)}U(x);function f(e){return/^https?:\/\//i.test(e||"")}function O(e){if(!e)return"";if(f(e))try{return new URL(e).pathname||""}catch{return e.split("?")[0]}return e.split("?")[0]}function P(e){return/\.(jpeg|jpg|gif|png|webp)$/i.test(O(e))}function q(e,i){if(e){const a=e.indexOf("@");return a>0?e.slice(0,a):e}return i?`User ${i.slice(0,8)}`:"Unknown author"}async function z(){try{L.style.display="block",p.style.display="none",w.style.display="none";const{data:e,error:i}=await m.rpc("get_public_prompts_with_authors",{p_category_id:null});if(i)throw i;const a={};(e||[]).forEach(r=>{const n=(r.category_name||"Uncategorized").trim()||"Uncategorized";a[n]||(a[n]={id:r.category_id||null,name:n,count:0}),a[n].count+=1,!a[n].id&&r.category_id&&(a[n].id=r.category_id)});const c=Object.values(a).sort((r,n)=>n.count!==r.count?n.count-r.count:r.name.localeCompare(n.name));if(x){const r=c.find(n=>n.name.toLowerCase()===x.toLowerCase());r!=null&&r.id?(b=r.id,E=!1,U(r.name)):(E=!0,U(x))}if(L.style.display="none",!c||c.length===0){w.style.display="block";return}p.style.display="block",p.innerHTML="";const u=document.createElement("li");u.className="nav-item mb-1",u.innerHTML=`
        <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${b===null?"active-category":""}" href="#" data-id="" data-name="">
          üìÅ All Categories
        </a>
      `,p.appendChild(u),c.forEach(r=>{const n=document.createElement("li");n.className="nav-item mb-1",n.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${b===r.id?"active-category":""}" href="#" data-id="${r.id}" data-name="${r.name}">
            <div class="d-flex justify-content-between align-items-center gap-2">
              <span>üìÅ ${r.name}</span>
              <span class="badge text-bg-secondary">${r.count}</span>
            </div>
          </a>
        `,p.appendChild(n)}),document.querySelectorAll(".category-link").forEach(r=>{r.addEventListener("click",n=>{n.preventDefault(),document.querySelectorAll(".category-link").forEach(s=>s.classList.remove("active-category")),n.currentTarget.classList.add("active-category");const t=n.currentTarget.getAttribute("data-id"),l=n.currentTarget.getAttribute("data-name")||"";b=t||null,E=!1,U(l),j(l),F()})})}catch(e){console.error("Error fetching categories:",e.message),L.style.display="none",w.style.display="block",w.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function F(){try{if(v.style.display="block",_.style.display="none",h.style.display="none",E){v.style.display="none",h.style.display="block";return}const{data:e,error:i}=await m.rpc("get_public_prompts_with_authors",{p_category_id:b}).order("created_at",{ascending:!0});if(i)throw i;if(v.style.display="none",!e||e.length===0){h.style.display="block";return}_.style.display="flex",_.innerHTML="";const a=[],c=[],u={};e.forEach(t=>{t.file_url&&(f(t.file_url)?u[t.file_url]=t.file_url:(c.push(t.file_url),P(t.file_url)&&a.push(t.file_url)),f(t.file_url)&&P(t.file_url)&&a.push(t.file_url))});const r={},n={};if(c.length>0){const t=[...new Set(c)],{data:l,error:s}=await m.storage.from("prompt-attachments").createSignedUrls(t,3600);!s&&l&&l.forEach(o=>{!o.error&&o.path&&o.signedUrl&&(n[o.path]=o.signedUrl)}),t.forEach(o=>{if(!n[o]){const{data:d}=m.storage.from("prompt-attachments").getPublicUrl(o);d!=null&&d.publicUrl&&(n[o]=d.publicUrl)}})}if(Object.entries(u).forEach(([t,l])=>{n[t]=l}),a.length>0){const t=a.filter(l=>!f(l));if(t.length>0){const{data:l,error:s}=await m.storage.from("prompt-attachments").createSignedUrls(t,3600);!s&&l&&l.forEach(o=>{o.error||(r[o.path]=o.signedUrl)})}a.filter(l=>f(l)).forEach(l=>{r[l]=l})}e.forEach(t=>{const l=t.category_name||"Uncategorized",s=q(t.author_email,t.user_id),o=document.createElement("div");o.className="col";let d="",y="";if(t.file_url){const g=n[t.file_url]||"",N=P(t.file_url);N&&r[t.file_url]?y=`<img src="${r[t.file_url]}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`:N&&g&&(y=`<img src="${g}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`),d=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}" data-resolved-url="${g}">üìé View Attachment</button>`}o.innerHTML=`
          <div class="card h-100 shadow-sm">
            ${y?`<div class="p-2 d-flex flex-wrap gap-2">${y}</div>`:""}
            <div class="card-body">
              <h5 class="card-title">${t.title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">üìÅ ${l}</h6>
              <p class="card-text text-muted small mb-2">By: ${s}</p>
              <p class="card-text text-truncate">${t.prompt_text}</p>
              <div class="d-flex flex-wrap">${d}</div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-start flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${t.id}">View Details</button>
            </div>
          </div>
        `,_.appendChild(o)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async l=>{const s=l.currentTarget.getAttribute("data-url"),o=l.currentTarget.getAttribute("data-resolved-url");if(o){window.open(o,"_blank");return}if(f(s)){window.open(s,"_blank");return}const{data:d,error:y}=await m.storage.from("prompt-attachments").createSignedUrl(s,3600);if(d)window.open(d.signedUrl,"_blank");else{const{data:g}=m.storage.from("prompt-attachments").getPublicUrl(s);g!=null&&g.publicUrl?window.open(g.publicUrl,"_blank"):(console.error("Error getting signed URL:",y),alert("Failed to load attachment."))}})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",l=>{const s=l.currentTarget.getAttribute("data-id"),o=e.find(d=>d.id===s);o&&R(o)})})}catch(e){console.error("Error fetching prompts:",e.message),v.style.display="none",h.style.display="block",h.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}const H=S("viewPromptModal"),A=document.getElementById("editPromptTitle"),k=document.getElementById("editPromptText"),I=document.getElementById("editPromptResult"),$=document.getElementById("editPromptFile"),C=document.getElementById("currentAttachmentContainer"),T=document.getElementById("currentAttachmentsList");async function R(e){if(!(!H||!A||!k||!I||!$||!C||!T)){if(A.value=e.title,k.value=e.prompt_text,I.value=e.result_text||"",$.value="",A.readOnly=!0,k.readOnly=!0,I.readOnly=!0,$.disabled=!0,T.innerHTML="",e.file_url){let i=e.file_url;if(!f(e.file_url)){const{data:c}=await m.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600);if(c!=null&&c.signedUrl)i=c.signedUrl;else{const{data:u}=m.storage.from("prompt-attachments").getPublicUrl(e.file_url);i=(u==null?void 0:u.publicUrl)||"#"}}const a=document.createElement("li");a.className="mb-2 d-flex align-items-center",a.innerHTML=`<a href="${i}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>`,T.appendChild(a),C.style.display="block"}else C.style.display="none";H.show()}}await z(),F()});
