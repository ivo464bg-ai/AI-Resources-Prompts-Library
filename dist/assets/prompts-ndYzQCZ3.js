import{s as i}from"./supabaseClient-8CxNeXQr.js";import{i as st}from"./roles-Dahpx40n.js";document.addEventListener("DOMContentLoaded",async()=>{const k=document.getElementById("logoutBtn"),M=document.getElementById("createPromptBtn"),S=document.getElementById("searchPrompts"),F=document.getElementById("nav-dashboard"),q=document.getElementById("nav-prompts"),U=document.getElementById("nav-admin"),D=document.getElementById("nav-login"),O=document.getElementById("nav-register"),R=document.getElementById("nav-logout"),H=document.getElementById("nav-user-email"),h=document.getElementById("nav-divider"),I=document.getElementById("promptsLoading"),u=document.getElementById("promptsContainer"),p=document.getElementById("promptsEmpty"),tt=document.getElementById("categoryTitle"),{data:{session:et},error:rt}=await i.auth.getSession(),d=!rt&&!!et,j=document.getElementById("user-email");let s=null;if(d&&j){const{data:{user:e},error:t}=await i.auth.getUser();!t&&e&&(s=e),e!=null&&e.email&&(j.textContent=e.email)}if(d){const e=await st(s==null?void 0:s.id);F.style.display="block",q.style.display="block",U.style.display=e?"block":"none",D.style.display="none",O.style.display="none",R.style.display="block",H.style.display="block",h&&h.style.setProperty("display","flex","important")}else F.style.display="none",q.style.display="none",U.style.display="none",D.style.display="block",O.style.display="block",R.style.display="none",H.style.display="none",h&&h.style.setProperty("display","none","important"),M.style.display="none";const N=new URLSearchParams(window.location.search),c=N.get("category"),P=N.get("search");let g=[],v={};async function ot(){const e=document.getElementById("promptCategorySelect");try{let t=i.from("categories").select("*").order("name",{ascending:!0});d&&(s!=null&&s.id)&&(t=t.eq("user_id",s.id));const{data:l,error:o}=await t;if(o)throw o;l.forEach(r=>{const n=document.createElement("option");n.value=r.id,n.textContent=r.name,c&&r.id===c&&(n.selected=!0,tt.textContent=`Prompts: ${r.name}`),e.appendChild(n)})}catch(t){console.error("Error fetching categories:",t.message)}}async function y(){try{I.style.display="block",u.style.display="none",p.style.display="none";let e=i.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});d&&(s!=null&&s.id)&&(e=e.eq("user_id",s.id)),c&&(e=e.eq("category_id",c));const{data:t,error:l}=await e;if(l)throw l;g=t;const o=[];if(t.forEach(r=>{r.file_url&&r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&o.push(r.file_url)}),v={},o.length>0){const{data:r,error:n}=await i.storage.from("prompt-attachments").createSignedUrls(o,3600);!n&&r&&r.forEach(a=>{a.error||(v[a.path]=a.signedUrl)})}if(P){S.value=P;const r=P.toLowerCase(),n=g.filter(a=>a.title.toLowerCase().includes(r)||a.prompt_text.toLowerCase().includes(r)||a.result_text&&a.result_text.toLowerCase().includes(r));E(n)}else E(g)}catch(e){console.error("Error fetching prompts:",e.message),I.style.display="none",p.style.display="block",p.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}function E(e){I.style.display="none",e.length===0?(u.style.display="none",p.style.display="block"):(p.style.display="none",u.style.display="flex",u.innerHTML="",e.forEach(t=>{var a;const l=((a=t.categories)==null?void 0:a.name)||"Uncategorized",o=document.createElement("div");o.className="col-12 mb-4";let r="",n="";t.file_url&&(t.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&v[t.file_url]?n+=`<img src="${v[t.file_url]}" class="card-img-top mb-2" alt="Attachment Preview" style="max-height: 150px; object-fit: cover;">`:r+=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}">ðŸ“Ž View Attachment</button>`),o.innerHTML=`
          <div class="card shadow-sm">
            ${n?`<div class="p-2 d-flex flex-wrap gap-2">${n}</div>`:""}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">${t.title}</h5>
              </div>
              <p class="card-text text-muted small">Category: ${l}</p>
              <div class="mb-3">
                <strong>Prompt:</strong>
                <p class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.prompt_text}</p>
              </div>
              ${t.result_text?`
              <div class="mb-3">
                <strong>Result:</strong>
                <div class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.result_text}</div>
              </div>
              `:""}
              <div class="d-flex flex-wrap mb-3">
                ${r}
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm view-prompt-btn" data-id="${t.id}">View Details</button>
                ${d?`<button class="btn btn-outline-danger btn-sm delete-prompt-btn" data-id="${t.id}">Delete</button>`:""}
              </div>
            </div>
          </div>
        `,u.appendChild(o)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async l=>{const o=l.currentTarget.getAttribute("data-url"),{data:r,error:n}=await i.storage.from("prompt-attachments").createSignedUrl(o,3600);r?window.open(r.signedUrl,"_blank"):(console.error("Error getting signed URL:",n),alert("Failed to load attachment."))})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",l=>{const o=l.currentTarget.getAttribute("data-id"),r=e.find(n=>n.id===o);r&&at(r)})}),d&&document.querySelectorAll(".delete-prompt-btn").forEach(t=>{t.addEventListener("click",async l=>{if(confirm("Are you sure you want to delete this prompt?")){const o=l.currentTarget.getAttribute("data-id");try{const r=e.find(a=>a.id===o);r&&r.file_url&&await i.storage.from("prompt-attachments").remove([r.file_url]);const{error:n}=await i.from("prompts").delete().eq("id",o);if(n)throw n;y()}catch(r){console.error("Error deleting prompt:",r.message),alert("Failed to delete prompt.")}}})}))}ot(),y(),k&&k.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await i.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});const V=new window.bootstrap.Modal(document.getElementById("addPromptModal")),nt=document.getElementById("savePromptBtn"),Q=document.getElementById("promptCategorySelect"),z=document.getElementById("promptTitle"),G=document.getElementById("promptText"),J=document.getElementById("promptResult"),K=document.getElementById("promptFile");d&&M.addEventListener("click",()=>{z.value="",G.value="",J.value="",K.value="",c&&(Q.value=c),V.show()}),nt.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id))return;const e=z.value.trim(),t=G.value.trim(),l=J.value.trim(),o=Q.value,r=K.files;if(!e||!t||!o){alert("Please fill in the required fields (Category, Title, and Prompt Text).");return}try{let n=null;if(r&&r.length>0){const m=r[0],b=m.name.split(".").pop(),T=`${Math.random().toString(36).substring(2,15)}.${b}`,w=`${s.id}/${T}`,{error:f}=await i.storage.from("prompt-attachments").upload(w,m);if(f)throw f;n=w}const{error:a}=await i.from("prompts").insert([{title:e,prompt_text:t,result_text:l,category_id:o,user_id:s.id,file_url:n}]);if(a)throw a;V.hide(),y(),alert("Prompt saved successfully!")}catch(n){console.error("Error creating prompt:",n.message),alert("Failed to create prompt: "+n.message)}});const W=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),X=document.getElementById("updatePromptBtn"),Y=document.getElementById("editPromptId"),x=document.getElementById("editPromptOldFileUrl"),B=document.getElementById("editPromptTitle"),_=document.getElementById("editPromptText"),L=document.getElementById("editPromptResult"),$=document.getElementById("editPromptFile"),C=document.getElementById("currentAttachmentContainer"),A=document.getElementById("currentAttachmentsList");async function at(e){const t=!d;Y.value=e.id,x.value=e.file_url||"",B.value=e.title,_.value=e.prompt_text,L.value=e.result_text||"",$.value="",B.readOnly=t,_.readOnly=t,L.readOnly=t,$.disabled=t,X.style.display=t?"none":"inline-block",A.innerHTML="";let l=!1;if(e.file_url){l=!0;const{data:o,error:r}=await i.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600),n=o?o.signedUrl:"#",a=document.createElement("li");a.className="mb-2 d-flex align-items-center",a.innerHTML=`
        <a href="${n}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>
        ${t?"":`<button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn" data-id="${e.id}" data-url="${e.file_url}">Remove</button>`}
      `,A.appendChild(a)}l?(C.style.display="block",t||document.querySelectorAll(".remove-attachment-btn").forEach(o=>{o.addEventListener("click",lt)})):C.style.display="none",W.show()}async function lt(e){if(confirm("Are you sure you want to remove this attachment?")){const t=e.currentTarget.getAttribute("data-id"),l=e.currentTarget.getAttribute("data-url");try{const{error:o}=await i.storage.from("prompt-attachments").remove([l]);if(o)throw o;const{error:r}=await i.from("prompts").update({file_url:null}).eq("id",t);if(r)throw r;e.currentTarget.closest("li").remove(),A.children.length===0&&(C.style.display="none"),x.value="",alert("Attachment removed successfully!"),y()}catch(o){console.error("Error removing attachment:",o.message),alert("Failed to remove attachment: "+o.message)}}}X.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id))return;const e=Y.value,t=x.value,l=B.value.trim(),o=_.value.trim(),r=L.value.trim(),n=$.files;if(!l||!o){alert("Please fill in the required fields (Title and Prompt Text).");return}try{let a={title:l,prompt_text:o,result_text:r};if(n&&n.length>0){const b=n[0],T=b.name.split(".").pop(),w=`${Math.random().toString(36).substring(2,15)}.${T}`,f=`${s.id}/${w}`,{error:Z}=await i.storage.from("prompt-attachments").upload(f,b);if(Z)throw Z;t&&await i.storage.from("prompt-attachments").remove([t]),a.file_url=f}const{error:m}=await i.from("prompts").update(a).eq("id",e);if(m)throw m;W.hide(),y(),alert("Prompt updated successfully!")}catch(a){console.error("Error updating prompt:",a.message),alert("Failed to update prompt: "+a.message)}}),S.addEventListener("input",e=>{const t=e.target.value.toLowerCase();if(!t){E(g);return}const l=g.filter(o=>o.title.toLowerCase().includes(t)||o.prompt_text.toLowerCase().includes(t)||o.result_text&&o.result_text.toLowerCase().includes(t));E(l)})});
