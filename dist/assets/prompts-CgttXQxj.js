import{s}from"./supabaseClient-Db4K6C7q.js";document.addEventListener("DOMContentLoaded",async()=>{const _=document.getElementById("logoutBtn"),M=document.getElementById("createPromptBtn"),y=document.getElementById("searchPrompts"),p=document.getElementById("promptsLoading"),i=document.getElementById("promptsContainer"),d=document.getElementById("promptsEmpty"),k=document.getElementById("categoryTitle"),{data:{session:S},error:q}=await s.auth.getSession();if(q||!S){window.location.href="../login/login.html";return}const f=document.getElementById("user-email");let h=null;if(f){const{data:{user:e},error:t}=await s.auth.getUser();if(t||!e){window.location.href="../login/login.html";return}h=e,e.email&&(f.textContent=e.email)}const w=new URLSearchParams(window.location.search),a=w.get("category"),g=w.get("search");let c=[];async function $(){const e=document.getElementById("promptCategorySelect");try{const{data:t,error:n}=await s.from("categories").select("*").order("name",{ascending:!0});if(n)throw n;t.forEach(o=>{const r=document.createElement("option");r.value=o.id,r.textContent=o.name,a&&o.id===a&&(r.selected=!0,k.textContent=`Prompts: ${o.name}`),e.appendChild(r)})}catch(t){console.error("Error fetching categories:",t.message)}}async function m(){try{p.style.display="block",i.style.display="none",d.style.display="none";let e=s.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});a&&(e=e.eq("category_id",a));const{data:t,error:n}=await e;if(n)throw n;if(c=t,g){y.value=g;const o=g.toLowerCase(),r=c.filter(l=>l.title.toLowerCase().includes(o)||l.prompt_text.toLowerCase().includes(o)||l.result_text&&l.result_text.toLowerCase().includes(o));u(r)}else u(c)}catch(e){console.error("Error fetching prompts:",e.message),p.style.display="none",d.style.display="block",d.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}function u(e){p.style.display="none",e.length===0?(i.style.display="none",d.style.display="block"):(d.style.display="none",i.style.display="flex",i.innerHTML="",e.forEach(t=>{var r;const n=((r=t.categories)==null?void 0:r.name)||"Uncategorized",o=document.createElement("div");o.className="col-12 mb-4",o.innerHTML=`
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">${t.title}</h5>
              </div>
              <p class="card-text text-muted small">Category: ${n}</p>
              <div class="mb-3">
                <strong>Prompt:</strong>
                <p class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.prompt_text}</p>
              </div>
              ${t.result_text?`
              <div class="mb-3">
                <strong>Result:</strong>
                <div class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.result_text}</div>
              </div>
              `:""}
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm view-prompt-btn" data-id="${t.id}">View Details</button>
                <button class="btn btn-outline-danger btn-sm delete-prompt-btn" data-id="${t.id}">Delete</button>
              </div>
            </div>
          </div>
        `,i.appendChild(o)}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",n=>{const o=n.currentTarget.getAttribute("data-id"),r=e.find(l=>l.id===o);r&&D(r)})}),document.querySelectorAll(".delete-prompt-btn").forEach(t=>{t.addEventListener("click",async n=>{if(confirm("Are you sure you want to delete this prompt?")){const o=n.currentTarget.getAttribute("data-id");try{const{error:r}=await s.from("prompts").delete().eq("id",o);if(r)throw r;m()}catch(r){console.error("Error deleting prompt:",r.message),alert("Failed to delete prompt.")}}})}))}$(),m(),_.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await s.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});const v=new window.bootstrap.Modal(document.getElementById("addPromptModal")),F=document.getElementById("savePromptBtn"),E=document.getElementById("promptCategorySelect"),I=document.getElementById("promptTitle"),P=document.getElementById("promptText"),b=document.getElementById("promptResult");M.addEventListener("click",()=>{I.value="",P.value="",b.value="",a&&(E.value=a),v.show()}),F.addEventListener("click",async()=>{const e=I.value.trim(),t=P.value.trim(),n=b.value.trim(),o=E.value;if(!e||!t||!o){alert("Please fill in the required fields (Category, Title, and Prompt Text).");return}try{const{error:r}=await s.from("prompts").insert([{title:e,prompt_text:t,result_text:n,category_id:o,user_id:h.id}]);if(r)throw r;v.hide(),m(),alert("Prompt saved successfully!")}catch(r){console.error("Error creating prompt:",r.message),alert("Failed to create prompt: "+r.message)}});const x=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),A=document.getElementById("updatePromptBtn"),B=document.getElementById("editPromptId"),C=document.getElementById("editPromptTitle"),L=document.getElementById("editPromptText"),T=document.getElementById("editPromptResult");function D(e){B.value=e.id,C.value=e.title,L.value=e.prompt_text,T.value=e.result_text||"",x.show()}A.addEventListener("click",async()=>{const e=B.value,t=C.value.trim(),n=L.value.trim(),o=T.value.trim();if(!t||!n){alert("Please fill in the required fields (Title and Prompt Text).");return}try{const{error:r}=await s.from("prompts").update({title:t,prompt_text:n,result_text:o}).eq("id",e);if(r)throw r;x.hide(),m(),alert("Prompt updated successfully!")}catch(r){console.error("Error updating prompt:",r.message),alert("Failed to update prompt: "+r.message)}}),y.addEventListener("input",e=>{const t=e.target.value.toLowerCase();if(!t){u(c);return}const n=c.filter(o=>o.title.toLowerCase().includes(t)||o.prompt_text.toLowerCase().includes(t)||o.result_text&&o.result_text.toLowerCase().includes(t));u(n)})});
