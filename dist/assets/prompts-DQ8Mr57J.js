import{s as i}from"./supabaseClient-8CxNeXQr.js";import{i as ct}from"./roles-DOHBFPxQ.js";document.addEventListener("DOMContentLoaded",async()=>{function j(e){var a;const t=document.getElementById(e);return!t||!((a=window.bootstrap)!=null&&a.Modal)?null:new window.bootstrap.Modal(t)}const I=document.getElementById("main-navbar"),N=document.getElementById("logoutBtn"),V=document.getElementById("createPromptBtn"),Q=document.getElementById("searchPrompts"),z=document.getElementById("nav-home"),G=document.getElementById("nav-dashboard"),J=document.getElementById("nav-prompts"),K=document.getElementById("nav-admin"),W=document.getElementById("nav-login"),X=document.getElementById("nav-register"),Y=document.getElementById("nav-logout"),Z=document.getElementById("nav-user-email"),P=document.getElementById("nav-divider"),H=document.getElementById("promptsLoading"),u=document.getElementById("promptsContainer"),p=document.getElementById("promptsEmpty"),ot=document.getElementById("categoryTitle"),{data:{session:at},error:lt}=await i.auth.getSession(),d=!lt&&!!at,tt=document.getElementById("user-email");let s=null;if(d&&tt){const{data:{user:e},error:t}=await i.auth.getUser();!t&&e&&(s=e),e!=null&&e.email&&(tt.textContent=e.email)}if(d){const e=await ct(s==null?void 0:s.id);z.style.display="block",G.style.display="block",J.style.display="block",K.style.display=e?"block":"none",W.style.display="none",X.style.display="none",Y.style.display="block",Z.style.display="block",P&&P.style.setProperty("display","flex","important"),I&&I.classList.remove("navbar-guest-mode")}else z.style.display="none",G.style.display="none",J.style.display="none",K.style.display="none",W.style.display="block",X.style.display="block",Y.style.display="none",Z.style.display="none",P&&P.style.setProperty("display","none","important"),I&&I.classList.add("navbar-guest-mode"),V.style.display="none";const et=new URLSearchParams(window.location.search),c=et.get("category"),O=et.get("search");let g=[],x={};async function st(){const e=document.getElementById("promptCategorySelect");try{let t=i.from("categories").select("*").order("name",{ascending:!0});d&&(s!=null&&s.id)&&(t=t.eq("user_id",s.id));const{data:a,error:n}=await t;if(n)throw n;a.forEach(r=>{const o=document.createElement("option");o.value=r.id,o.textContent=r.name,c&&r.id===c&&(o.selected=!0,ot.textContent=`Prompts: ${r.name}`),e.appendChild(o)})}catch(t){console.error("Error fetching categories:",t.message)}}async function y(){try{H.style.display="block",u.style.display="none",p.style.display="none";let e=i.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});d&&(s!=null&&s.id)&&(e=e.eq("user_id",s.id)),c&&(e=e.eq("category_id",c));const{data:t,error:a}=await e;if(a)throw a;g=t;const n=[];if(t.forEach(r=>{r.file_url&&r.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&n.push(r.file_url)}),x={},n.length>0){const{data:r,error:o}=await i.storage.from("prompt-attachments").createSignedUrls(n,3600);!o&&r&&r.forEach(l=>{l.error||(x[l.path]=l.signedUrl)})}if(O){Q.value=O;const r=O.toLowerCase(),o=g.filter(l=>l.title.toLowerCase().includes(r)||l.prompt_text.toLowerCase().includes(r)||l.result_text&&l.result_text.toLowerCase().includes(r));B(o)}else B(g)}catch(e){console.error("Error fetching prompts:",e.message),H.style.display="none",p.style.display="block",p.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}function B(e){H.style.display="none",e.length===0?(u.style.display="none",p.style.display="block"):(p.style.display="none",u.style.display="flex",u.innerHTML="",e.forEach(t=>{var l;const a=((l=t.categories)==null?void 0:l.name)||"Uncategorized",n=document.createElement("div");n.className="col-12 mb-4";let r="",o="";t.file_url&&(t.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&x[t.file_url]?o+=`<img src="${x[t.file_url]}" class="card-img-top mb-2" alt="Attachment Preview" style="max-height: 150px; object-fit: cover;">`:r+=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}">ðŸ“Ž View Attachment</button>`),n.innerHTML=`
          <div class="card shadow-sm">
            ${o?`<div class="p-2 d-flex flex-wrap gap-2">${o}</div>`:""}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">${t.title}</h5>
              </div>
              <p class="card-text text-muted small">Category: ${a}</p>
              <div class="mb-3">
                <strong>Prompt:</strong>
                <p class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.prompt_text}</p>
              </div>
              ${t.result_text?`
              <div class="mb-3">
                <strong>Result:</strong>
                <div class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.result_text}</div>
              </div>
              `:""}
              <div class="d-flex flex-wrap mb-3">
                ${r}
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm view-prompt-btn" data-id="${t.id}">View Details</button>
                ${d?`<button class="btn btn-outline-danger btn-sm delete-prompt-btn" data-id="${t.id}">Delete</button>`:""}
              </div>
            </div>
          </div>
        `,u.appendChild(n)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async a=>{const n=a.currentTarget.getAttribute("data-url"),{data:r,error:o}=await i.storage.from("prompt-attachments").createSignedUrl(n,3600);r?window.open(r.signedUrl,"_blank"):(console.error("Error getting signed URL:",o),alert("Failed to load attachment."))})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",a=>{const n=a.currentTarget.getAttribute("data-id"),r=e.find(o=>o.id===n);r&&it(r)})}),d&&document.querySelectorAll(".delete-prompt-btn").forEach(t=>{t.addEventListener("click",async a=>{if(confirm("Are you sure you want to delete this prompt?")){const n=a.currentTarget.getAttribute("data-id");try{const r=e.find(l=>l.id===n);r&&r.file_url&&await i.storage.from("prompt-attachments").remove([r.file_url]);const{error:o}=await i.from("prompts").delete().eq("id",n);if(o)throw o;y()}catch(r){console.error("Error deleting prompt:",r.message),alert("Failed to delete prompt.")}}})}))}st(),y(),N&&N.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await i.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});const _=j("addPromptModal"),rt=document.getElementById("savePromptBtn"),L=document.getElementById("promptCategorySelect"),$=document.getElementById("promptTitle"),A=document.getElementById("promptText"),C=document.getElementById("promptResult"),T=document.getElementById("promptFile");d&&V.addEventListener("click",()=>{!_||!$||!A||!C||!T||!L||($.value="",A.value="",C.value="",T.value="",c&&(L.value=c),_.show())}),rt&&rt.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id)||!$||!A||!C||!L||!T)return;const e=$.value.trim(),t=A.value.trim(),a=C.value.trim(),n=L.value,r=T.files;if(!e||!t||!n){alert("Please fill in the required fields (Category, Title, and Prompt Text).");return}try{let o=null;if(r&&r.length>0){const m=r[0],U=m.name.split(".").pop(),R=`${Math.random().toString(36).substring(2,15)}.${U}`,D=`${s.id}/${R}`,{error:w}=await i.storage.from("prompt-attachments").upload(D,m);if(w)throw w;o=D}const{error:l}=await i.from("prompts").insert([{title:e,prompt_text:t,result_text:a,category_id:n,user_id:s.id,file_url:o}]);if(l)throw l;_&&_.hide(),y(),alert("Prompt saved successfully!")}catch(o){console.error("Error creating prompt:",o.message),alert("Failed to create prompt: "+o.message)}});const k=j("viewPromptModal"),M=document.getElementById("updatePromptBtn"),S=document.getElementById("editPromptId"),f=document.getElementById("editPromptOldFileUrl"),h=document.getElementById("editPromptTitle"),v=document.getElementById("editPromptText"),b=document.getElementById("editPromptResult"),E=document.getElementById("editPromptFile"),F=document.getElementById("currentAttachmentContainer"),q=document.getElementById("currentAttachmentsList");async function it(e){if(!k||!S||!f||!h||!v||!b||!E||!M||!F||!q)return;const t=!d;S.value=e.id,f.value=e.file_url||"",h.value=e.title,v.value=e.prompt_text,b.value=e.result_text||"",E.value="",h.readOnly=t,v.readOnly=t,b.readOnly=t,E.disabled=t,M.style.display=t?"none":"inline-block",q.innerHTML="";let a=!1;if(e.file_url){a=!0;const{data:n,error:r}=await i.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600),o=n?n.signedUrl:"#",l=document.createElement("li");l.className="mb-2 d-flex align-items-center",l.innerHTML=`
        <a href="${o}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>
        ${t?"":`<button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn" data-id="${e.id}" data-url="${e.file_url}">Remove</button>`}
      `,q.appendChild(l)}a?(F.style.display="block",t||document.querySelectorAll(".remove-attachment-btn").forEach(n=>{n.addEventListener("click",dt)})):F.style.display="none",k.show()}async function dt(e){if(confirm("Are you sure you want to remove this attachment?")){const t=e.currentTarget.getAttribute("data-id"),a=e.currentTarget.getAttribute("data-url");try{const{error:n}=await i.storage.from("prompt-attachments").remove([a]);if(n)throw n;const{error:r}=await i.from("prompts").update({file_url:null}).eq("id",t);if(r)throw r;e.currentTarget.closest("li").remove(),q.children.length===0&&(F.style.display="none"),f.value="",alert("Attachment removed successfully!"),y()}catch(n){console.error("Error removing attachment:",n.message),alert("Failed to remove attachment: "+n.message)}}}M&&M.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id)||!S||!f||!h||!v||!b||!E)return;const e=S.value,t=f.value,a=h.value.trim(),n=v.value.trim(),r=b.value.trim(),o=E.files;if(!a||!n){alert("Please fill in the required fields (Title and Prompt Text).");return}try{let l={title:a,prompt_text:n,result_text:r};if(o&&o.length>0){const U=o[0],R=U.name.split(".").pop(),D=`${Math.random().toString(36).substring(2,15)}.${R}`,w=`${s.id}/${D}`,{error:nt}=await i.storage.from("prompt-attachments").upload(w,U);if(nt)throw nt;t&&await i.storage.from("prompt-attachments").remove([t]),l.file_url=w}const{error:m}=await i.from("prompts").update(l).eq("id",e);if(m)throw m;k&&k.hide(),y(),alert("Prompt updated successfully!")}catch(l){console.error("Error updating prompt:",l.message),alert("Failed to update prompt: "+l.message)}}),Q.addEventListener("input",e=>{const t=e.target.value.toLowerCase();if(!t){B(g);return}const a=g.filter(n=>n.title.toLowerCase().includes(t)||n.prompt_text.toLowerCase().includes(t)||n.result_text&&n.result_text.toLowerCase().includes(t));B(a)})});
