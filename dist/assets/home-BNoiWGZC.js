import{s as d}from"./supabaseClient-8CxNeXQr.js";import{i as ne}from"./roles-DOHBFPxQ.js";document.addEventListener("DOMContentLoaded",async()=>{var R,V;const b=document.getElementById("main-navbar"),T=document.getElementById("logout-btn"),C=document.getElementById("nav-home"),H=document.getElementById("nav-dashboard"),S=document.getElementById("nav-admin"),F=document.getElementById("nav-login"),O=document.getElementById("nav-register"),N=document.getElementById("nav-logout"),j=document.getElementById("nav-user-email"),v=document.getElementById("nav-divider"),Q=document.getElementById("user-email-display"),I=document.getElementById("categoriesLoading"),h=document.getElementById("categoriesList"),E=document.getElementById("categoriesEmpty"),U=document.getElementById("promptsLoading"),w=document.getElementById("promptsContainer"),_=document.getElementById("promptsEmpty");function W(e){var l;const r=document.getElementById(e);return!r||!((l=window.bootstrap)!=null&&l.Modal)?null:new window.bootstrap.Modal(r)}const{data:{session:m},error:G}=await d.auth.getSession(),J=!G&&!!m,K=((R=m==null?void 0:m.user)==null?void 0:R.id)||null,X=((V=m==null?void 0:m.user)==null?void 0:V.email)||null;if(J){const e=await ne(K);C.style.display="block",H.style.display="block",S.style.display=e?"block":"none",F.style.display="none",O.style.display="none",N.style.display="block",j.style.display="block",Q.textContent=X,v&&v.style.setProperty("display","flex","important"),b&&b.classList.remove("navbar-guest-mode")}else C.style.display="none",H.style.display="none",S.style.display="none",F.style.display="block",O.style.display="block",N.style.display="none",j.style.display="none",v&&v.style.setProperty("display","none","important"),b&&b.classList.add("navbar-guest-mode");T&&T.addEventListener("click",async e=>{e.preventDefault();const{error:r}=await d.auth.signOut();r?(console.error("Error logging out:",r.message),alert("Failed to log out.")):window.location.reload()});let x=null;function g(e){return/^https?:\/\//i.test(e||"")}function Y(e){if(!e)return"";if(g(e))try{return new URL(e).pathname||""}catch{return e.split("?")[0]}return e.split("?")[0]}function k(e){return/\.(jpeg|jpg|gif|png|webp)$/i.test(Y(e))}function Z(e,r){if(e){const l=e.indexOf("@");return l>0?e.slice(0,l):e}return r?`User ${r.slice(0,8)}`:"Unknown author"}async function ee(){try{I.style.display="block",h.style.display="none",E.style.display="none";const{data:e,error:r}=await d.from("categories").select("*").order("created_at",{ascending:!1});if(r)throw r;if(I.style.display="none",!e||e.length===0){E.style.display="block";return}h.style.display="block",h.innerHTML="";const l=document.createElement("li");l.className="nav-item mb-1",l.innerHTML=`
        <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${x===null?"active-category":""}" href="#" data-id="">
          üìÅ All Categories
        </a>
      `,h.appendChild(l),e.forEach(s=>{const i=document.createElement("li");i.className="nav-item mb-1",i.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${x===s.id?"active-category":""}" href="#" data-id="${s.id}">
            üìÅ ${s.name}
          </a>
        `,h.appendChild(i)}),document.querySelectorAll(".category-link").forEach(s=>{s.addEventListener("click",i=>{i.preventDefault(),document.querySelectorAll(".category-link").forEach(p=>p.classList.remove("active-category")),i.currentTarget.classList.add("active-category");const y=i.currentTarget.getAttribute("data-id");x=y||null,D()})})}catch(e){console.error("Error fetching categories:",e.message),I.style.display="none",E.style.display="block",E.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function D(){try{U.style.display="block",w.style.display="none",_.style.display="none";const{data:e,error:r}=await d.rpc("get_public_prompts_with_authors",{p_category_id:x}).order("created_at",{ascending:!0});if(r)throw r;if(U.style.display="none",!e||e.length===0){_.style.display="block";return}w.style.display="flex",w.innerHTML="";const l=[],s=[],i={};e.forEach(t=>{t.file_url&&(g(t.file_url)?i[t.file_url]=t.file_url:(s.push(t.file_url),k(t.file_url)&&l.push(t.file_url)),g(t.file_url)&&k(t.file_url)&&l.push(t.file_url))});const y={},p={};if(s.length>0){const t=[...new Set(s)],{data:a,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&a&&a.forEach(n=>{!n.error&&n.path&&n.signedUrl&&(p[n.path]=n.signedUrl)}),t.forEach(n=>{if(!p[n]){const{data:c}=d.storage.from("prompt-attachments").getPublicUrl(n);c!=null&&c.publicUrl&&(p[n]=c.publicUrl)}})}if(Object.entries(i).forEach(([t,a])=>{p[t]=a}),l.length>0){const t=l.filter(a=>!g(a));if(t.length>0){const{data:a,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(t,3600);!o&&a&&a.forEach(n=>{n.error||(y[n.path]=n.signedUrl)})}l.filter(a=>g(a)).forEach(a=>{y[a]=a})}e.forEach(t=>{const a=t.category_name||"Uncategorized",o=Z(t.author_email,t.user_id),n=document.createElement("div");n.className="col";let c="",f="";if(t.file_url){const u=p[t.file_url]||"",z=k(t.file_url);z&&y[t.file_url]?f=`<img src="${y[t.file_url]}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`:z&&u&&(f=`<img src="${u}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`),c=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}" data-resolved-url="${u}">üìé View Attachment</button>`}n.innerHTML=`
          <div class="card h-100 shadow-sm">
            ${f?`<div class="p-2 d-flex flex-wrap gap-2">${f}</div>`:""}
            <div class="card-body">
              <h5 class="card-title">${t.title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">üìÅ ${a}</h6>
              <p class="card-text text-muted small mb-2">By: ${o}</p>
              <p class="card-text text-truncate">${t.prompt_text}</p>
              <div class="d-flex flex-wrap">${c}</div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-start flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${t.id}">View Details</button>
            </div>
          </div>
        `,w.appendChild(n)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async a=>{const o=a.currentTarget.getAttribute("data-url"),n=a.currentTarget.getAttribute("data-resolved-url");if(n){window.open(n,"_blank");return}if(g(o)){window.open(o,"_blank");return}const{data:c,error:f}=await d.storage.from("prompt-attachments").createSignedUrl(o,3600);if(c)window.open(c.signedUrl,"_blank");else{const{data:u}=d.storage.from("prompt-attachments").getPublicUrl(o);u!=null&&u.publicUrl?window.open(u.publicUrl,"_blank"):(console.error("Error getting signed URL:",f),alert("Failed to load attachment."))}})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",a=>{const o=a.currentTarget.getAttribute("data-id"),n=e.find(c=>c.id===o);n&&te(n)})})}catch(e){console.error("Error fetching prompts:",e.message),U.style.display="none",_.style.display="block",_.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}const q=W("viewPromptModal"),L=document.getElementById("editPromptTitle"),A=document.getElementById("editPromptText"),B=document.getElementById("editPromptResult"),P=document.getElementById("editPromptFile"),M=document.getElementById("currentAttachmentContainer"),$=document.getElementById("currentAttachmentsList");async function te(e){if(!(!q||!L||!A||!B||!P||!M||!$)){if(L.value=e.title,A.value=e.prompt_text,B.value=e.result_text||"",P.value="",L.readOnly=!0,A.readOnly=!0,B.readOnly=!0,P.disabled=!0,$.innerHTML="",e.file_url){let r=e.file_url;if(!g(e.file_url)){const{data:s}=await d.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600);if(s!=null&&s.signedUrl)r=s.signedUrl;else{const{data:i}=d.storage.from("prompt-attachments").getPublicUrl(e.file_url);r=(i==null?void 0:i.publicUrl)||"#"}}const l=document.createElement("li");l.className="mb-2 d-flex align-items-center",l.innerHTML=`<a href="${r}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>`,$.appendChild(l),M.style.display="block"}else M.style.display="none";q.show()}}ee(),D()});
