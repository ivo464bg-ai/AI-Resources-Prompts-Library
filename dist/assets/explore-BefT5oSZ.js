import{s as d}from"./supabaseClient-8CxNeXQr.js";/* empty css               */import{i as tt}from"./roles-BbqFL7ZG.js";document.addEventListener("DOMContentLoaded",async()=>{var N,q;const $=document.getElementById("logout-btn"),T=document.getElementById("nav-dashboard"),C=document.getElementById("nav-admin"),H=document.getElementById("nav-login"),S=document.getElementById("nav-register"),F=document.getElementById("nav-logout"),O=document.getElementById("nav-user-email"),b=document.getElementById("nav-divider"),V=document.getElementById("user-email-display"),x=document.getElementById("categoriesLoading"),h=document.getElementById("categoriesList"),v=document.getElementById("categoriesEmpty"),U=document.getElementById("promptsLoading"),E=document.getElementById("promptsContainer"),w=document.getElementById("promptsEmpty");function z(t){var a;const l=document.getElementById(t);return!l||!((a=window.bootstrap)!=null&&a.Modal)?null:new window.bootstrap.Modal(l)}const{data:{session:m},error:Q}=await d.auth.getSession(),W=!Q&&!!m,G=((N=m==null?void 0:m.user)==null?void 0:N.id)||null,J=((q=m==null?void 0:m.user)==null?void 0:q.email)||null;if(W){const t=await tt(G);T.style.display="block",C.style.display=t?"block":"none",H.style.display="none",S.style.display="none",F.style.display="block",O.style.display="block",V.textContent=J||"",b&&b.style.setProperty("display","flex","important")}else T.style.display="none",C.style.display="none",H.style.display="block",S.style.display="block",F.style.display="none",O.style.display="none",b&&b.style.setProperty("display","none","important");$&&$.addEventListener("click",async t=>{t.preventDefault();const{error:l}=await d.auth.signOut();if(l){alert("Failed to log out.");return}window.location.href="../home/home.html"});let _=null;function g(t){return/^https?:\/\//i.test(t||"")}function K(t){if(!t)return"";if(g(t))try{return new URL(t).pathname||""}catch{return t.split("?")[0]}return t.split("?")[0]}function k(t){return/\.(jpeg|jpg|gif|png|webp)$/i.test(K(t))}function X(t,l){if(t){const a=t.indexOf("@");return a>0?t.slice(0,a):t}return l?`User ${l.slice(0,8)}`:"Unknown author"}async function Y(){try{x.style.display="block",h.style.display="none",v.style.display="none";const{data:t,error:l}=await d.from("categories").select("*").order("created_at",{ascending:!1});if(l)throw l;if(x.style.display="none",!t||t.length===0){v.style.display="block";return}h.style.display="block",h.innerHTML="";const a=document.createElement("li");a.className="nav-item mb-1",a.innerHTML=`
        <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${_===null?"active-category":""}" href="#" data-id="">
          üìÅ All Categories
        </a>
      `,h.appendChild(a),t.forEach(i=>{const s=document.createElement("li");s.className="nav-item mb-1",s.innerHTML=`
          <a class="nav-link text-dark bg-white border rounded py-2 px-3 category-link ${_===i.id?"active-category":""}" href="#" data-id="${i.id}">
            üìÅ ${i.name}
          </a>
        `,h.appendChild(s)}),document.querySelectorAll(".category-link").forEach(i=>{i.addEventListener("click",s=>{s.preventDefault(),document.querySelectorAll(".category-link").forEach(p=>p.classList.remove("active-category")),s.currentTarget.classList.add("active-category");const y=s.currentTarget.getAttribute("data-id");_=y||null,j()})})}catch(t){console.error("Error fetching categories:",t.message),x.style.display="none",v.style.display="block",v.innerHTML='<small class="text-danger">Failed to load categories.</small>'}}async function j(){try{U.style.display="block",E.style.display="none",w.style.display="none";const{data:t,error:l}=await d.rpc("get_public_prompts_with_authors",{p_category_id:_}).order("created_at",{ascending:!0});if(l)throw l;if(U.style.display="none",!t||t.length===0){w.style.display="block";return}E.style.display="flex",E.innerHTML="";const a=[],i=[],s={};t.forEach(e=>{e.file_url&&(g(e.file_url)?s[e.file_url]=e.file_url:(i.push(e.file_url),k(e.file_url)&&a.push(e.file_url)),g(e.file_url)&&k(e.file_url)&&a.push(e.file_url))});const y={},p={};if(i.length>0){const e=[...new Set(i)],{data:r,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(e,3600);!o&&r&&r.forEach(n=>{!n.error&&n.path&&n.signedUrl&&(p[n.path]=n.signedUrl)}),e.forEach(n=>{if(!p[n]){const{data:c}=d.storage.from("prompt-attachments").getPublicUrl(n);c!=null&&c.publicUrl&&(p[n]=c.publicUrl)}})}if(Object.entries(s).forEach(([e,r])=>{p[e]=r}),a.length>0){const e=a.filter(r=>!g(r));if(e.length>0){const{data:r,error:o}=await d.storage.from("prompt-attachments").createSignedUrls(e,3600);!o&&r&&r.forEach(n=>{n.error||(y[n.path]=n.signedUrl)})}a.filter(r=>g(r)).forEach(r=>{y[r]=r})}t.forEach(e=>{const r=e.category_name||"Uncategorized",o=X(e.author_email,e.user_id),n=document.createElement("div");n.className="col";let c="",f="";if(e.file_url){const u=p[e.file_url]||"",R=k(e.file_url);R&&y[e.file_url]?f=`<img src="${y[e.file_url]}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`:R&&u&&(f=`<img src="${u}" alt="Attachment Preview" style="max-height: 150px; object-fit: cover; width: 100%; border-radius: 8px; margin-bottom: 10px;">`),c=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${e.file_url}" data-resolved-url="${u}">üìé View Attachment</button>`}n.innerHTML=`
          <div class="card h-100 shadow-sm">
            ${f?`<div class="p-2 d-flex flex-wrap gap-2">${f}</div>`:""}
            <div class="card-body">
              <h5 class="card-title">${e.title}</h5>
              <h6 class="card-subtitle mb-2 text-muted">üìÅ ${r}</h6>
              <p class="card-text text-muted small mb-2">By: ${o}</p>
              <p class="card-text text-truncate">${e.prompt_text}</p>
              <div class="d-flex flex-wrap">${c}</div>
            </div>
            <div class="card-footer bg-transparent border-top-0 d-flex justify-content-start flex-wrap gap-2">
              <button class="btn btn-sm btn-outline-primary view-prompt-btn" data-id="${e.id}">View Details</button>
            </div>
          </div>
        `,E.appendChild(n)}),document.querySelectorAll(".view-attachment-btn").forEach(e=>{e.addEventListener("click",async r=>{const o=r.currentTarget.getAttribute("data-url"),n=r.currentTarget.getAttribute("data-resolved-url");if(n){window.open(n,"_blank");return}if(g(o)){window.open(o,"_blank");return}const{data:c,error:f}=await d.storage.from("prompt-attachments").createSignedUrl(o,3600);if(c)window.open(c.signedUrl,"_blank");else{const{data:u}=d.storage.from("prompt-attachments").getPublicUrl(o);u!=null&&u.publicUrl?window.open(u.publicUrl,"_blank"):(console.error("Error getting signed URL:",f),alert("Failed to load attachment."))}})}),document.querySelectorAll(".view-prompt-btn").forEach(e=>{e.addEventListener("click",r=>{const o=r.currentTarget.getAttribute("data-id"),n=t.find(c=>c.id===o);n&&Z(n)})})}catch(t){console.error("Error fetching prompts:",t.message),U.style.display="none",w.style.display="block",w.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}const D=z("viewPromptModal"),I=document.getElementById("editPromptTitle"),L=document.getElementById("editPromptText"),A=document.getElementById("editPromptResult"),B=document.getElementById("editPromptFile"),P=document.getElementById("currentAttachmentContainer"),M=document.getElementById("currentAttachmentsList");async function Z(t){if(!(!D||!I||!L||!A||!B||!P||!M)){if(I.value=t.title,L.value=t.prompt_text,A.value=t.result_text||"",B.value="",I.readOnly=!0,L.readOnly=!0,A.readOnly=!0,B.disabled=!0,M.innerHTML="",t.file_url){let l=t.file_url;if(!g(t.file_url)){const{data:i}=await d.storage.from("prompt-attachments").createSignedUrl(t.file_url,3600);if(i!=null&&i.signedUrl)l=i.signedUrl;else{const{data:s}=d.storage.from("prompt-attachments").getPublicUrl(t.file_url);l=(s==null?void 0:s.publicUrl)||"#"}}const a=document.createElement("li");a.className="mb-2 d-flex align-items-center",a.innerHTML=`<a href="${l}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>`,M.appendChild(a),P.style.display="block"}else P.style.display="none";D.show()}}Y(),j()});
