import{s as i}from"./supabaseClient-8CxNeXQr.js";import{i as dt}from"./roles-CRsL3K8t.js";document.addEventListener("DOMContentLoaded",async()=>{const h=document.getElementById("main-navbar"),M=document.getElementById("logoutBtn"),S=document.getElementById("createPromptBtn"),F=document.getElementById("searchPrompts"),q=document.getElementById("nav-home"),U=document.getElementById("nav-dashboard"),D=document.getElementById("nav-prompts"),H=document.getElementById("nav-admin"),O=document.getElementById("nav-login"),R=document.getElementById("nav-register"),j=document.getElementById("nav-logout"),N=document.getElementById("nav-user-email"),v=document.getElementById("nav-divider"),P=document.getElementById("promptsLoading"),u=document.getElementById("promptsContainer"),p=document.getElementById("promptsEmpty"),nt=document.getElementById("categoryTitle"),{data:{session:ot},error:rt}=await i.auth.getSession(),d=!rt&&!!ot,V=document.getElementById("user-email");let s=null;if(d&&V){const{data:{user:e},error:t}=await i.auth.getUser();!t&&e&&(s=e),e!=null&&e.email&&(V.textContent=e.email)}if(d){const e=await dt(s==null?void 0:s.id);q.style.display="block",U.style.display="block",D.style.display="block",H.style.display=e?"block":"none",O.style.display="none",R.style.display="none",j.style.display="block",N.style.display="block",v&&v.style.setProperty("display","flex","important"),h&&h.classList.remove("navbar-guest-mode")}else q.style.display="none",U.style.display="none",D.style.display="none",H.style.display="none",O.style.display="block",R.style.display="block",j.style.display="none",N.style.display="none",v&&v.style.setProperty("display","none","important"),h&&h.classList.add("navbar-guest-mode"),S.style.display="none";const Q=new URLSearchParams(window.location.search),c=Q.get("category"),x=Q.get("search");let g=[],b={};async function at(){const e=document.getElementById("promptCategorySelect");try{let t=i.from("categories").select("*").order("name",{ascending:!0});d&&(s!=null&&s.id)&&(t=t.eq("user_id",s.id));const{data:l,error:o}=await t;if(o)throw o;l.forEach(n=>{const r=document.createElement("option");r.value=n.id,r.textContent=n.name,c&&n.id===c&&(r.selected=!0,nt.textContent=`Prompts: ${n.name}`),e.appendChild(r)})}catch(t){console.error("Error fetching categories:",t.message)}}async function y(){try{P.style.display="block",u.style.display="none",p.style.display="none";let e=i.from("prompts").select("*, categories(name)").order("created_at",{ascending:!1});d&&(s!=null&&s.id)&&(e=e.eq("user_id",s.id)),c&&(e=e.eq("category_id",c));const{data:t,error:l}=await e;if(l)throw l;g=t;const o=[];if(t.forEach(n=>{n.file_url&&n.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&o.push(n.file_url)}),b={},o.length>0){const{data:n,error:r}=await i.storage.from("prompt-attachments").createSignedUrls(o,3600);!r&&n&&n.forEach(a=>{a.error||(b[a.path]=a.signedUrl)})}if(x){F.value=x;const n=x.toLowerCase(),r=g.filter(a=>a.title.toLowerCase().includes(n)||a.prompt_text.toLowerCase().includes(n)||a.result_text&&a.result_text.toLowerCase().includes(n));E(r)}else E(g)}catch(e){console.error("Error fetching prompts:",e.message),P.style.display="none",p.style.display="block",p.innerHTML='<h5 class="text-danger">Failed to load prompts.</h5>'}}function E(e){P.style.display="none",e.length===0?(u.style.display="none",p.style.display="block"):(p.style.display="none",u.style.display="flex",u.innerHTML="",e.forEach(t=>{var a;const l=((a=t.categories)==null?void 0:a.name)||"Uncategorized",o=document.createElement("div");o.className="col-12 mb-4";let n="",r="";t.file_url&&(t.file_url.match(/\.(jpeg|jpg|gif|png|webp)$/i)&&b[t.file_url]?r+=`<img src="${b[t.file_url]}" class="card-img-top mb-2" alt="Attachment Preview" style="max-height: 150px; object-fit: cover;">`:n+=`<button class="btn btn-sm btn-outline-secondary view-attachment-btn mt-2 me-2" data-url="${t.file_url}">ðŸ“Ž View Attachment</button>`),o.innerHTML=`
          <div class="card shadow-sm">
            ${r?`<div class="p-2 d-flex flex-wrap gap-2">${r}</div>`:""}
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0">${t.title}</h5>
              </div>
              <p class="card-text text-muted small">Category: ${l}</p>
              <div class="mb-3">
                <strong>Prompt:</strong>
                <p class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.prompt_text}</p>
              </div>
              ${t.result_text?`
              <div class="mb-3">
                <strong>Result:</strong>
                <div class="bg-light p-2 rounded border" style="white-space: pre-wrap;">${t.result_text}</div>
              </div>
              `:""}
              <div class="d-flex flex-wrap mb-3">
                ${n}
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm view-prompt-btn" data-id="${t.id}">View Details</button>
                ${d?`<button class="btn btn-outline-danger btn-sm delete-prompt-btn" data-id="${t.id}">Delete</button>`:""}
              </div>
            </div>
          </div>
        `,u.appendChild(o)}),document.querySelectorAll(".view-attachment-btn").forEach(t=>{t.addEventListener("click",async l=>{const o=l.currentTarget.getAttribute("data-url"),{data:n,error:r}=await i.storage.from("prompt-attachments").createSignedUrl(o,3600);n?window.open(n.signedUrl,"_blank"):(console.error("Error getting signed URL:",r),alert("Failed to load attachment."))})}),document.querySelectorAll(".view-prompt-btn").forEach(t=>{t.addEventListener("click",l=>{const o=l.currentTarget.getAttribute("data-id"),n=e.find(r=>r.id===o);n&&st(n)})}),d&&document.querySelectorAll(".delete-prompt-btn").forEach(t=>{t.addEventListener("click",async l=>{if(confirm("Are you sure you want to delete this prompt?")){const o=l.currentTarget.getAttribute("data-id");try{const n=e.find(a=>a.id===o);n&&n.file_url&&await i.storage.from("prompt-attachments").remove([n.file_url]);const{error:r}=await i.from("prompts").delete().eq("id",o);if(r)throw r;y()}catch(n){console.error("Error deleting prompt:",n.message),alert("Failed to delete prompt.")}}})}))}at(),y(),M&&M.addEventListener("click",async e=>{e.preventDefault();const{error:t}=await i.auth.signOut();t?(console.error("Error logging out:",t.message),alert("Failed to log out.")):window.location.href="../../index.html"});const z=new window.bootstrap.Modal(document.getElementById("addPromptModal")),lt=document.getElementById("savePromptBtn"),G=document.getElementById("promptCategorySelect"),J=document.getElementById("promptTitle"),K=document.getElementById("promptText"),W=document.getElementById("promptResult"),X=document.getElementById("promptFile");d&&S.addEventListener("click",()=>{J.value="",K.value="",W.value="",X.value="",c&&(G.value=c),z.show()}),lt.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id))return;const e=J.value.trim(),t=K.value.trim(),l=W.value.trim(),o=G.value,n=X.files;if(!e||!t||!o){alert("Please fill in the required fields (Category, Title, and Prompt Text).");return}try{let r=null;if(n&&n.length>0){const m=n[0],w=m.name.split(".").pop(),k=`${Math.random().toString(36).substring(2,15)}.${w}`,I=`${s.id}/${k}`,{error:f}=await i.storage.from("prompt-attachments").upload(I,m);if(f)throw f;r=I}const{error:a}=await i.from("prompts").insert([{title:e,prompt_text:t,result_text:l,category_id:o,user_id:s.id,file_url:r}]);if(a)throw a;z.hide(),y(),alert("Prompt saved successfully!")}catch(r){console.error("Error creating prompt:",r.message),alert("Failed to create prompt: "+r.message)}});const Y=new window.bootstrap.Modal(document.getElementById("viewPromptModal")),Z=document.getElementById("updatePromptBtn"),tt=document.getElementById("editPromptId"),B=document.getElementById("editPromptOldFileUrl"),_=document.getElementById("editPromptTitle"),L=document.getElementById("editPromptText"),$=document.getElementById("editPromptResult"),C=document.getElementById("editPromptFile"),A=document.getElementById("currentAttachmentContainer"),T=document.getElementById("currentAttachmentsList");async function st(e){const t=!d;tt.value=e.id,B.value=e.file_url||"",_.value=e.title,L.value=e.prompt_text,$.value=e.result_text||"",C.value="",_.readOnly=t,L.readOnly=t,$.readOnly=t,C.disabled=t,Z.style.display=t?"none":"inline-block",T.innerHTML="";let l=!1;if(e.file_url){l=!0;const{data:o,error:n}=await i.storage.from("prompt-attachments").createSignedUrl(e.file_url,3600),r=o?o.signedUrl:"#",a=document.createElement("li");a.className="mb-2 d-flex align-items-center",a.innerHTML=`
        <a href="${r}" target="_blank" class="me-2 text-truncate" style="max-width: 200px;">Attachment</a>
        ${t?"":`<button type="button" class="btn btn-sm btn-outline-danger remove-attachment-btn" data-id="${e.id}" data-url="${e.file_url}">Remove</button>`}
      `,T.appendChild(a)}l?(A.style.display="block",t||document.querySelectorAll(".remove-attachment-btn").forEach(o=>{o.addEventListener("click",it)})):A.style.display="none",Y.show()}async function it(e){if(confirm("Are you sure you want to remove this attachment?")){const t=e.currentTarget.getAttribute("data-id"),l=e.currentTarget.getAttribute("data-url");try{const{error:o}=await i.storage.from("prompt-attachments").remove([l]);if(o)throw o;const{error:n}=await i.from("prompts").update({file_url:null}).eq("id",t);if(n)throw n;e.currentTarget.closest("li").remove(),T.children.length===0&&(A.style.display="none"),B.value="",alert("Attachment removed successfully!"),y()}catch(o){console.error("Error removing attachment:",o.message),alert("Failed to remove attachment: "+o.message)}}}Z.addEventListener("click",async()=>{if(!d||!(s!=null&&s.id))return;const e=tt.value,t=B.value,l=_.value.trim(),o=L.value.trim(),n=$.value.trim(),r=C.files;if(!l||!o){alert("Please fill in the required fields (Title and Prompt Text).");return}try{let a={title:l,prompt_text:o,result_text:n};if(r&&r.length>0){const w=r[0],k=w.name.split(".").pop(),I=`${Math.random().toString(36).substring(2,15)}.${k}`,f=`${s.id}/${I}`,{error:et}=await i.storage.from("prompt-attachments").upload(f,w);if(et)throw et;t&&await i.storage.from("prompt-attachments").remove([t]),a.file_url=f}const{error:m}=await i.from("prompts").update(a).eq("id",e);if(m)throw m;Y.hide(),y(),alert("Prompt updated successfully!")}catch(a){console.error("Error updating prompt:",a.message),alert("Failed to update prompt: "+a.message)}}),F.addEventListener("input",e=>{const t=e.target.value.toLowerCase();if(!t){E(g);return}const l=g.filter(o=>o.title.toLowerCase().includes(t)||o.prompt_text.toLowerCase().includes(t)||o.result_text&&o.result_text.toLowerCase().includes(t));E(l)})});
